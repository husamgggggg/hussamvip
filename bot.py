import os
import telebot
import openai
import base64
from dotenv import load_dotenv

# --- 1. ุชุญููู ุงูุฅุนุฏุงุฏุงุช ูููุงุชูุญ ุงูู API ---
load_dotenv()
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

if not TELEGRAM_TOKEN or not OPENAI_API_KEY:
    raise ValueError("ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ูุถุน ููุงุชูุญ API ูู ููู .env")

bot = telebot.TeleBot(TELEGRAM_TOKEN)
client = openai.OpenAI(api_key=OPENAI_API_KEY)

# --- 2. ูุต ุงูุฃูุฑ ุงูุชุญูููู ---
# --- 2. ูุต ุงูุฃูุฑ ุงูุชุญูููู (ูุณุฎุฉ ูุญุณูุฉ ููุฎูุงุฑุงุช ุงูุซูุงุฆูุฉ) ---
# --- 2. ูุต ุงูุฃูุฑ ุงูุชุญูููู (ูุณุฎุฉ ูุทูุฑุฉ ูุฏูุฌ ุงููุคุดุฑุงุช) ---
PROMPT_TEXT = """
ุฃูุช ูุญูู ููู ุฎุจูุฑ ููููุชู ูู ุฅุตุฏุงุฑ ุฅุดุงุฑุงุช ุฏูููุฉ ูุชุฏุงูู ุงูุฎูุงุฑุงุช ุงูุซูุงุฆูุฉ ุนูู ุฅุทุงุฑ ุฒููู 5 ุฏูุงุฆู.

**ุนูููุฉ ุงูุชุญููู (ุงุชุจุน ูุฐู ุงูุฎุทูุงุช ุจุงูุชุฑุชูุจ):**

**ุงูุฎุทูุฉ 1: ุชุญููู ุงููุคุดุฑุงุช ุงููููุฉ (ุงูุฃููููุฉ ุงููุตูู)**
- ุงุจุญุซ ุจุชุฑููุฒ ูู ุงูุตูุฑุฉ ุนู ุฃู ูุคุดุฑุงุช ูููุฉ (ูุซู RSI, MACD, Stochastic, Bollinger Bands, Moving Averages).
- ุญูู ุญุงูุฉ ูู ูุคุดุฑ. ูู ูู ูู ููุทูุฉ ุชุดุจุน ุจูุน (Oversold)ุ ุฃู ุชุดุจุน ุดุฑุงุก (Overbought)ุ ูู ููุงู ุชูุงุทุน (Cross)ุ ูู ููุงู ุชุจุงุนุฏ (Divergence) ุจูู ุงููุคุดุฑ ูุงูุณุนุฑุ

**ุงูุฎุทูุฉ 2: ุชุญููู ุญุฑูุฉ ุงูุณุนุฑ (ูุชุฃููุฏ ุฅุดุงุฑุฉ ุงููุคุดุฑุงุช)**
- ุญูู ุงูุดููุน ุงููุงุจุงููุฉ ุงูุฃุฎูุฑุฉ. ูู ููุงู ููุงุฐุฌ ุงูุนูุงุณูุฉ (ูุซู ุดูุนุฉ ุงุจุชูุงุนูุฉุ ูุทุฑูุฉ) ุฃู ุงุณุชูุฑุงุฑูุฉุ
- ุญุฏุฏ ุฃูุฑุจ ูุณุชููุงุช ุฏุนู ูููุงููุฉ ูููุฉ.
ุงุนุชูุฏ ุนูู ููุงุทู ุงูุฏุนู ูุงูููุงููุฉ ุงูุฏุฎููุฉ
**ุงูุฎุทูุฉ 3: ุฅุตุฏุงุฑ ุงูุชูุตูุฉ ุงูููุงุฆูุฉ**
- ุงุฏูุฌ ูุชุงุฆุฌ ุงูุฎุทูุชูู 1 ู 2. ูุฌุจ ุฃู ุชููู ุงูุชูุตูุฉ ุงูููุงุฆูุฉ ูุฏุนููุฉ ุจููุฉ ูู ุงููุคุดุฑุงุช ูุญุฑูุฉ ุงูุณุนุฑ ูุนูุง.
- ุฅุฐุง ูุงูุช ุงููุคุดุฑุงุช ูุญุฑูุฉ ุงูุณุนุฑ ูุชุนุงุฑุถุชููุ ุงุฐูุฑ ุฐูู ูููู ูู ููุฉ ุงูุฅุดุงุฑุฉ.

**ุชูุณูู ุงูุฑุฏ ุงููุทููุจ (ููู ุฌุฏูุง ูููุฌุฒ):**

**ุงูุตููุฉ:** [ุตุนูุฏ (CALL) ุฃู ูุจูุท (PUT)]
**ููุฉ ุงูุฅุดุงุฑุฉ:** [ุชูููู ูู 1 ุฅูู 10ุ ุญูุซ 10 ูู ุงูุฃููู ูุงูุฃูุซุฑ ุชุฃููุฏูุง]
ููุง ุชุฐูุฑ ุณุจุจ ุงูุงุดุงุฑุฉ ุงู ุชุญููู ุงูุฐู ุงุณุชูุชุฌุชู
"""


# --- 3. ูุนุงูุฌ ุงูุฑุณุงุฆู ุงูุชู ุชุญุชูู ุนูู ุตูุฑ ---
@bot.message_handler(content_types=['photo'])
def handle_photo(message):
    try:
        bot.reply_to(message, "ููุฏ ุงุณุชููุช ุงูุตูุฑุฉุ ุฌุงุฑู ุชุญููููุง... ๐ค")

        # ุชูุฒูู ุงูุตูุฑุฉ
        file_id = message.photo[-1].file_id
        file_info = bot.get_file(file_id)
        downloaded_file = bot.download_file(file_info.file_path)

        # ุชุญููู ุงูุตูุฑุฉ ุฅูู Base64
        base64_image = base64.b64encode(downloaded_file).decode('utf-8')
        image_url = f"data:image/jpeg;base64,{base64_image}"

        print("เธเธณเธฅเธฑเธเธชเนเธ ุงูุทูุจ ุฅูู OpenAI...")
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": PROMPT_TEXT},
                        {"type": "image_url", "image_url": {"url": image_url}}
                    ]
                }
            ],
            max_tokens=1000
        )
        print("ุชู ุงุณุชูุงู ุงูุฑุฏ ูู OpenAI.")

        # ุฅุฑุณุงู ุงูุฑุฏ ูููุณุชุฎุฏู
        analysis_result = response.choices[0].message.content
        bot.reply_to(message, analysis_result)

    except Exception as e:
        print(f"ุญุฏุซ ุฎุทุฃ: {e}")
        bot.reply_to(message, "ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ูุง ุฃุซูุงุก ุชุญููู ุงูุตูุฑุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.")

# --- 4. ุชุดุบูู ุงูุจูุช ---
print("ุงูุจูุช ููุฏ ุงูุชุดุบูู ุงูุขู...")
bot.polling()
